#!/usr/bin/perl
print "usage:\nwilcoxtest <profile> <group1_list> <group2_list>\n" and exit unless scalar @ARGV == 3;
$profile = $ARGV[0];
$group1 = $ARGV[1];
$group1 =~ m/(.*).list/;
$prefix_group1 = $1;
$group2 = $ARGV[2];
$group2 =~ m/(.*).list/;
$prefix_group2 = $1;
open OUT,">wilcox.test.R";
print OUT <<_END_;
library(qvalue);
profile_name = "$profile";
group1 = as.vector(t(read.table("$group1")));
group2 = as.vector(t(read.table("$group2")));
data = read.table(profile_name,head=TRUE);
group1_number = which(colnames(data) %in% group1);
group2_number = which(colnames(data) %in% group2);
p_values = apply(data, 1, function(x,y=group1_number, z=group2_number) wilcox.test(unlist(x[y]),unlist(x[z]),pair=FALSE,alternative="two.sided")\$p.value);
pi0 = qvalue(na.omit(p_values))\$pi0;
q_values = p.adjust(p_values,method="fdr");
info = cbind(p_values,q_values);
write.table(info,"$profile.p",col.names=FALSE,sep="\\t",quote=FALSE);
pdf("$profile.p.pdf");
hist = hist(p_values,probability=TRUE,breaks=50,main="histogram of p values",xlab="p values");
abline(h=pi0,lty=2);
power = cumsum(hist\$density-pi0)/50/(1-pi0);
fdr = pi0*(1:50)/cumsum(hist\$density);
power = c(0,power);
fdr = c(0,fdr);
cex = max(hist\$density);
lines(x=(0:50)/50,y=power*cex,type="o",pch=4,cex=0.5,col=2,lwd=1);
lines(x=(0:50)/50,y=fdr*cex,type="o",pch=4,cex=0.5,col=4,lwd=1);
legend(x=1,y=max(fdr*cex),legend=c("estimate power","estimate fdr"),col=c(2,4),xjust=1,yjust=0,pch=4,lwd=1,pt.cex=0.5,bty="n");
legend(x=1,y=pi0,legend="Null Hypothesis",xjust=1,yjust=0,bty="n");
axis(4,at=(0:5)/5*cex,labels=(0:5)/5);
dev.off();
_END_
close OUT;
open OUT,">wilcox.test.enrich.R";
print OUT <<_END_;
profile_name = "$profile";
group1 = as.vector(t(read.table("$group1")));
group2 = as.vector(t(read.table("$group2")));
data = read.table(profile_name,head=TRUE);
group1_number = which(colnames(data) %in% group1);
group2_number = which(colnames(data) %in% group2);
p_values = apply(data, 1, function(x,y=group1_number, z=group2_number) wilcox.test(unlist(x[y]),unlist(x[z]),pair=FALSE,alternative="less")\$p.value);
enrich = rep("$prefix_group1",nrow(data));
enrich[which(p_values<0.5)] = "$prefix_group2";
gene = rownames(data);
info = cbind(gene,enrich)
write.table(info,"$profile.enrich",col.names=FALSE,sep="\\t",quote=FALSE,row.names=FALSE);
_END_
close OUT;
open PIPE,"|qsub -cwd -l vf=10g -q all.q -N wilcox.test.R";
print PIPE "Rscript wilcox.test.R";
close PIPE;
open PIPE,"|qsub -cwd -l vf=10g -q all.q -N wilcox.test.enrich.R";
print PIPE "Rscript wilcox.test.enrich.R";
close PIPE;
